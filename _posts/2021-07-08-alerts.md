---
title: "Stock alert applet"
---

A stock alert applet (under development). 

<audio id="audio" src="{{ "that-was-quick.mp3" | relative_url }}" autostart="false"></audio>
<button onclick="toggleAlerts(this);">Alerts Off</button>


<div>
	
<input onkeyup="if (event.keyCode == 27) this.value = '';
		else if (event.keyCode == 13) {
			event.preventDefault(); 
			submitTicker();
		}"
id="tickerInput" autocomplete="off" placeholder="Add stock ticker..."> 
<span style="padding-left:20px" id="msg"></span>

<br>
<div id="ticker"></div>
<div id="market"></div>
	
<ul id="stocklist"></ul>
	
</div>

<script> ////////////////////////////////////////////////////////////////
var tickerList = [];
let hourglasstimer;
	
function toggleAlerts(elt) {
	if (hourglasstimer) {
		elt.style.backgroundColor = "";
		elt.textContent = "Alerts Off";
		clearInterval(hourglasstimer);
		hourglasstimer = "";
	} else {	
		D('audio').play();
		elt.style.backgroundColor = "#aaa";
		elt.textContent = "Alerts On";
		hourglasstimer = setInterval(function() {
			update();
		}, 5000);
	}
}
	
function update() {
	tickerList.forEach(function(stock) {
		console.log("updating " + stock);
	
		let current = parseInt(D(stock + "-current").value);
		let upper = parseInt(D(stock + "-upper").value);
		let lower = parseInt(D(stock + "-lower").value);
	
		let ring = false;
	
		if (current < lower) {
			if (D(stock + "-lower").style.fontWeight != "bold") ring = true;
			D(stock + "-lower").style.fontWeight = "bold";
		} else D(stock + "-lower").style.fontWeight = "initial";
		if (current > upper) {
			if (D(stock + "-upper").style.fontWeight != "bold") ring = true;
			D(stock + "-upper").style.fontWeight = "bold";
		} else D(stock + "-upper").style.fontWeight = "initial";
	
		if (ring) D('audio').play();
	});
}
	
function submitTicker() {
	// options: https://query2.finance.yahoo.com/v7/finance/options/
	// quote: https://query1.finance.yahoo.com/v7/finance/quote?symbols=
	let query = 'https://query1.finance.yahoo.com/v7/finance/quote?symbols=' + D('tickerInput').value;	
	fetch("https://sandboxansyble.herokuapp.com/", 
		{cache:'no-cache', headers: {'Target-URL': query }}).then(function(response) {
		return response.json();
	}).then(function(data) { 
	
	// let buffer = data.optionChain.result[0].quote;
	let buffer = data.quoteResponse.result[0];
	
	if (buffer) {	
		let stock = buffer.symbol;
		D('ticker').textContent = "Ticker: " + stock;
		D('market').textContent = "Market: " + buffer.regularMarketPrice;
	
		if (!tickerList.includes(stock)) {
			D('msg').textContent = "Ticker added.";
			tickerList.push(stock);

			let newli = make("li");
			newli.id = stock;
	
			let newTickerX = make("button");
			newTickerX.textContent = "X";
			newTickerX.onclick = function() { 
				tickerList.splice(tickerList.indexOf(stock), 1); 
				remove(newli); 
				D('msg').textContent = "Ticker removed.";
			};	
	
			let newTicker = make("div");
			newTicker.style.padding = "10px";
			newTicker.textContent = stock;
			newTicker.style.display = "inline-block";	
				newTicker.style.textAlign = "center";
				newTicker.style.width = "100px";
	
			let lowerBound = make("input");
			lowerBound.value = Math.floor(buffer.regularMarketPrice * 0.9 *100)/100;
			lowerBound.id = stock + "-lower";
				lowerBound.style.textAlign = "center";
				lowerBound.style.width = "100px";	
			lowerBound.onblur = function() { update() };
	
			let current = make("input");
			current.value = Math.floor(buffer.regularMarketPrice * 1 *100)/100;
			current.id = stock + "-current";
			current.disabled = true;
			current.style.border = "0px";
			current.style.backgroundColor = "white";
			current.style.color = "#333";
				current.style.textAlign = "center";
				current.style.width = "100px";
	
			let upperBound = make("input");
			upperBound.value = Math.floor(buffer.regularMarketPrice * 1.1*100)/100;
			upperBound.id = stock + "-upper";
				upperBound.style.textAlign = "center";
				upperBound.style.width = "100px";
			upperBound.onblur = function() { update() };
	
			newli.appendChild(newTickerX);
			newli.appendChild(newTicker);
			newli.appendChild(lowerBound);
			newli.appendChild(current);
			newli.appendChild(upperBound);
			D('stocklist').appendChild(newli);
		} else {
			D('stocklist').appendChild(D(stock));	
			D('msg').textContent = "Ticker already added.";
		}
	
		D('tickerInput').value = "";
	
	} else D('msg').textContent = "Ticker doesn't exist.";	
	}).catch(function(error) { console.log(error); });	
}
	
	
function D(string) { return document.getElementById(string);}
function make(string) { return document.createElement(string);}	
function remove(element) { element.parentNode.removeChild(element);}
</script>
    
