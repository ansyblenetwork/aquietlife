---
title: "Stock alert applet"
---

A stock alert applet which emits a ring/notification for price movements beyond a specified range, and for elevated price/volume activity. This is tuned for events on the intra-day scale.



<div style="min-width:400px; margin-top: 40px; margin-bottom: 40px">

<div style="margin-bottom:20px;">
<audio id="audiodown" src="{{ "case-closed-531.mp3" | relative_url }}" autostart="false"></audio>
<audio id="audio" src="{{ "that-was-quick.mp3" | relative_url }}" autostart="false"></audio>
<button onclick="toggleSound(this);" id="soundButton" class="active">Sound On</button>
<button onclick="toggleNotifications(this);" id="notificationButton">Notifications Off</button>
<div style="float:right">
	<span id="msg" style="margin-right:10px;"></span>
	<button onclick="update(); updateAll();">Refresh</button>
	<button onclick="toggleAlerts(this);">Auto-Refresh Off</button>
</div>
</div>
	
<div style="margin-bottom:10px; text-align:center" id="stocktwits">Trending on <a target='_blank' href='https://stocktwits.com/'>Stocktwits</a> with <strong>weeklys</strong></div>
<button id="stButton" style="margin:0px auto 20px auto; display:block;" onclick="if (this.textContent == 'Load') updateStocktwits(); else addAll(stWeeklyList);">Load</button>
	
<div style="margin-bottom:10px; text-align:center" id="yolo">Trending on <a target='_blank' href='https://yolostocks.live/'>YoloStocks</a> with <strong>weeklys</strong></div>
<button id="yoloButton" style="margin:0px auto 20px auto; display:block;" onclick="if (this.textContent == 'Load') updateYolo(); else addAll(yoloWeeklyList);">Load</button>
	
<div style="margin-bottom:10px; text-align:center" id="wsb">Trending on <a target='_blank' href='https://dashboard.nbshare.io/apps/reddit/wallstreetbets/'>WSB</a> with <strong>weeklys</strong></div>
<button id="wsbButton" style="margin:0px auto 20px auto; display:block;" onclick="if (this.textContent == 'Load') updateWSB(); else addAll(wsbWeeklyList);">Load</button>
	
<div style="margin-bottom:10px; text-align:center" id="earnings"><a target='_blank' href='https://finance.yahoo.com/calendar/earnings'>Earnings</a> within a week with weeklys</div>
<button id="earningsButton" style="margin:0px auto 20px auto; display:block;" onclick="if (this.textContent == 'Load') updateEarnings(); else addAll(earnings)">Load</button>
	
<div style="margin-bottom:10px; text-align:center" id="merge">Top 5 from each source, ranked by options</div>
<button id="mergeButton" style="margin:0px auto 20px auto; display:block;" onclick="mergeAll()">Load and Rank</button>
	
<div style="width:max-content; margin:auto">
<input onkeyup="if (event.keyCode == 27) this.value = '';
		else if (event.keyCode == 13) {
			event.preventDefault(); 
			optionsChain();
		}"
id="optionsInput" type="text" style="margin:10px;" autocomplete="off" placeholder="Options chain..."> 
</div>
	
<ul style="list-style-type:none; padding-left:0px;" id="optionslist"></ul>
	
	
<div style="width:max-content; margin:auto">
<input id="defaultLower" onblur="if (!this.value) this.value = 0; defaultLower = val(this);" type="text" autocomplete="off" value="2" placeholder="Margin..."> % 
<input onkeyup="if (event.keyCode == 27) this.value = '';
		else if (event.keyCode == 13) {
			event.preventDefault(); 
			submitTicker();
		}"
id="tickerInput" type="text" style="margin-left:10px; margin-right:10px" autocomplete="off" placeholder="Monitor stock..."> 
<input id="defaultUpper" onblur="if (!this.value) this.value = 0; defaultUpper = val(this)" type="text" autocomplete="off" value="2" placeholder="Margin..."> % 
</div>
	
<ul style="list-style-type:none; padding-left:0px" id="stocklist"></ul>	
	
	
</div>


<script> ////////////////////////////////////////////////////////////////

var stList = [];
var stWeeklyList = [];
var yoloList = [];
var yoloWeeklyList = [];
var wsbList = [];
var wsbWeeklyList = [];
var earnings = [];
var merge = [];
	
var optionsData = {};
	
var tickerList = [];
var volumes = {};
var prices = {};
var weeklys = ["AA","AAL","AAOI","AAPL","ABBV","ABC","ABNB","ABT","ACAD","ACB","ACN","ADBE","ADI","ADM","ADP","ADS","ADSK","AEO","AFL","AG","AGNC","AIG","AKAM","ALGN","AMAT","AMBA","AMC","AMD","AMGN","AMRN","AMRS","AMT","AMZN","ANET","ANF","ANTM","APA","APO","APPH","APPS","APT","ARVL","ASML","ATOS","ATVI","AUY","AVGO","AVXL","AXP","AZN","AZO","BA","BABA","BAC","BAX","BB","BBBY","BBY","BDX","BHC","BIDU","BIIB","BILI","BK","BKNG","BLK","BLNK","BMY","BNTX","BP","BSX","BUD","BURL","BX","BYND","C","CAG","CAH","CAT","CBOE","CC","CCIV","CCJ","CCL","CF","CGC","CHPT","CHTR","CHWY","CI","CIEN","CL","CLDR","CLF","CLOV","CLR","CLVS","CLX","CMCSA","CME","CMG","CNC","CNP","CODX","COF","COG","COIN","COP","COST","COTY","COUP","CPB","CPRI","CREE","CRM","CRON","CRSP","CRWD","CSCO","CSIQ","CSTM","CSX","CTSH","CTXS","CVNA","CVS","CVX","CWH","CYBR","CYH","CYRX","CZR","DAL","DASH","DB","DBX","DD","DDD","DDOG","DE","DFS","DG","DHI","DIDI","DIS","DISH","DKNG","DKS","DLTR","DOCU","DOW","DPZ","DVN","EA","EBAY","ED","EDIT","EGHT","EMR","ENDP","ENPH","EOG","EPD","ET","ETN","ETSY","EW","EXAS","EXPE","EXPR","F","FB","FCEL","FCX","FDX","FEYE","FFIV","FISV","FIVE","FL","FLEX","FLR","FOSL","FOXA","FSLR","FSLY","FSR","FUBO","FUTU","GD","GE","GILD","GLW","GM","GME","GNUS","GNW","GOEV","GOLD","GOOG","GOOGL","GOOS","GP","GPRO","GPS","GRPN","GRWG","GS","GSK","GT","HAL","HAS","HBI","HCA","HD","HES","HFC","HIG","HIMX","HL","HLF","HOG","HON","HPE","HPQ","HRL","HSBC","HSY","HUM","HUYA","HYLN","IBM","IFF","ILMN","INFN","INO","INTC","INTU","IP","IQ","IRBT","ISRG","ITW","IVR","JCI","JD","JMIA","JNJ","JNPR","JPM","JWN","KEY","KGC","KHC","KKR","KLAC","KMB","KMI","KMX","KO","KODK","KR","KSS","KSU","LAZR","LB","LBTYK","LEN","LI","LITE","LL","LLNW","LLY","LMND","LMT","LNG","LOW","LRCX","LULU","LUMN","LUV","LVS","LYFT","M","MA","MAR","MARA","MAT","MCD","MCHP","MCK","MDB","MDLZ","MDT","MELI","MET","MGM","MMM","MNKD","MNST","MO","MOMO","MOS","MPC","MRK","MRNA","MRO","MRVL","MS","MSFT","MSTR","MT","MTCH","MU","MVIS","NBEV","NCLH","NEM","NET","NFLX","NIO","NKE","NKLA","NKTR","NLY","NNOX","NOC","NOK","NOV","NOW","NSC","NTAP","NTES","NTNX","NTR","NUE","NVAX","NVDA","NXPI","OCGN","OKE","OKTA","OLED","OLN","ON","OPK","ORCL","OSTK","OXY","PAA","PANW","PBR","PCG","PDD","PENN","PEP","PFE","PG","PHM","PINS","PLAY","PLTR","PLUG","PM","PNC","PPG","PSAC","PSTH","PSX","PSXP","PTON","PXD","PYPL","PZZA","QCOM","QDEL","QS","RACE","RAD","RBLX","RCL","REGN","RH","RIDE","RIG","RIOT","RKT","RMO","RNG","ROKU","ROST","RRC","RTX","RVLV","SABR","SBUX","SCHW","SDC","SE","SEAS","SFIX","SHAK","SHOP","SIG","SIRI","SKLZ","SKX","SLB","SNAP","SNDL","SNOW","SNPS","SO","SOFI","SOL","SOLO","SONO","SONY","SOS","SPCE","SPGI","SPLK","SPOT","SPWR","SQ","SRNE","SRPT","SSYS","STEM","STMP","STNE","STX","STZ","SU","SWK","SWKS","SWN","SYF","SYY","T","TAP","TDOC","TEAM","TECK","TEVA","TGT","THC","TJX","TLRY","TME","TMUS","TNDM","TOL","TPR","TRIP","TSCO","TSLA","TSM","TSN","TTD","TTM","TTWO","TWLO","TWTR","TXN","UA","UAA","UAL","UBER","ULTA","UNH","UNP","UPS","UPST","URBN","URI","USB","V","VALE","VFC","VIAC","VIPS","VIR","VLO","VMW","VOD","VRTX","VTRS","VXRT","VZ","W","WB","WBA","WDAY","WDC","WFC","WHR","WISH","WKHS","WMB","WMT","WOOF","WORK","WPM","WW","WY","WYNN","X","XLNX","XOM","XPEV","YELP","YETI","YNDX","YPF","YUM","YY","Z","ZM","ZNGA","ZS"];
	
var defaultUpper = 2;
var defaultLower = 2;
let yahootimer;
let sttimer;
let wsbtimer;
var d = new Date();
if (Notification.permission === "granted") activate(D('notificationButton'), "Notifications On");
setInput(D('defaultLower')); 
setInput(D('defaultUpper'));
D('defaultLower').style.width = "60px";
D('defaultUpper').style.width = "60px";
	
								   								      
function addAll(dataset) {
	D('tickerInput').value = dataset.join(); 
	submitTicker();
}
	
function updateAll() {
	updateStocktwits();
	updateYolo();
	updateWSB();
}
	
function mergeAll() {
	merge = [];
	for (let i = 0; (i < stWeeklyList.length) && (i < 5); i++) {
		if (!merge.includes(stWeeklyList[i])) merge.push(stWeeklyList[i]);						
	}	
	for (let i = 0; (i < yoloWeeklyList.length) && (i < 5); i++) {
		if (!merge.includes(yoloWeeklyList[i])) merge.push(yoloWeeklyList[i]);						
	}
	for (let i = 0; (i < wsbWeeklyList.length) && (i < 5); i++) {
		if (!merge.includes(wsbWeeklyList[i])) merge.push(wsbWeeklyList[i]);						
	}
	for (let i = 0; (i < earnings.length) && (i < 5); i++) {
		if (!merge.includes(earnings[i])) merge.push(earnings[i]);						
	}
	
	let mergeString = "";
	for (let i = 0; i < merge.length; i++) {
		mergeString += "<strong  style='color:#333'>" + merge[i] + "</strong> ";
	}
	if (mergeString) D('merge').innerHTML = mergeString;
}
					 
					 
					 
					 
					 
					 
					 
								       
function analyze() {	
								       
	let d = new Date(Date.now() + 1000*60*60*24*12).toISOString();
	let maxdata =  {};
					 
					 
	let promises = [];
	for (let i = 0; i < merge.length; i++) {	 
	promises.push(
	fetch("https://api.tdameritrade.com/v1/marketdata/chains?apikey=T1V8GYUYK3GKC7HG3L23O9XBJ5OH1C4F&symbol="
						+ merge[i]
						+ "&range=OTM&toDate="
						+ d).then(function(response) {
		return response.json();
	}).then(function(data) {
		console.log(data);
		if (data.status == "SUCCESS") {
			maxdata[merge[i]] = {call:0, put:0};
			for (let contractDate in data.callExpDateMap) {
						   
			/////////////////////// CALLS //////////////////////////////////
						   
				let dstrike = 0;
				let dpremium = 0; 
				let theStrike;
							
				let astrike = 0;
				let apremium = 0; 
				let theaStrike;
								       
				for (let contractStrike in data.callExpDateMap[contractDate]) {	
					let contract = data.callExpDateMap[contractDate][contractStrike][0];	
					if (contract.ask > 0) {	
						if (dpremium) {
							if (contract.ask < dpremium
								&& (apremium == 0 || dpremium < apremium || (dpremium == apremium && dstrike < astrike))) {
								astrike = dstrike;
								apremium = dpremium;
								theaStrike = theStrike;	
							} else if (contract.ask > dpremium 
								&& (apremium == 0 || contract.ask < apremium || (contract.ask == apremium && contract.strikePrice < astrike))) {
								astrike = contract.strikePrice;
								apremium = contract.ask;
								theaStrike = contractStrike;			       
							}
						}
						if (dpremium == 0 || contract.ask < dpremium || (contract.ask == dpremium && contract.strikePrice < dstrike)) {
							dstrike = contract.strikePrice;
							dpremium = contract.ask;
							theStrike = contractStrike;
						}
					}
				}	
				
								       
				for (let contractStrike in data.callExpDateMap[contractDate]) {
					let contract = data.callExpDateMap[contractDate][contractStrike][0];
					if (contract.tradeTimeInLong) lastTrade = Math.round((Date.now() - contract.tradeTimeInLong)/60000);
					returnrate = Math.round(100*(contract.bid - dpremium)*365*1000*60*60*24
							/((dstrike - contract.strikePrice)*(contract.expirationDate-Date.now())));
					returnrate2 = Math.round(100*(contract.bid - apremium)*365*1000*60*60*24
							/((astrike - contract.strikePrice)*(contract.expirationDate-Date.now())));
					margin = Math.round(100*(contract.strikePrice - data.underlyingPrice)/data.underlyingPrice);
					let threshold = 19;
					if (contract.daysToExpiration < 3) threshold = 0;  
					if (contract.bid > dpremium && lastTrade < 12*60 && returnrate > 19 && margin > threshold) {
						if (returnrate2 > maxdata[merge[i]].call) maxdata[merge[i]].call = returnrate2;
					}
				}
	
			/////////////////////// PUTS //////////////////////////////////
	
				dstrike = 0;
				dpremium = 0; 							
				astrike = 0;
				apremium = 0; 	
				theaStrike = "";
				theStrike = "";
				for (let contractStrike in data.putExpDateMap[contractDate]) {	
					let contract = data.putExpDateMap[contractDate][contractStrike][0];	
					if (contract.ask > 0) {	
						if (dpremium) {
							if (contract.ask < dpremium
								&& (apremium == 0 || dpremium < apremium || (dpremium == apremium && dstrike > astrike))) {
								astrike = dstrike;
								apremium = dpremium;
								theaStrike = theStrike;	
							} else if (contract.ask > dpremium 
								&& (apremium == 0 || contract.ask < apremium || (contract.ask == apremium && contract.strikePrice > astrike))) {
								astrike = contract.strikePrice;
								apremium = contract.ask;
								theaStrike = contractStrike;			       
							}
						}
						if (dpremium == 0 || contract.ask < dpremium || (contract.ask == dpremium && contract.strikePrice > dstrike)) {
							dstrike = contract.strikePrice;
							dpremium = contract.ask;
							theStrike = contractStrike;
						}
					}
				}	
								       
				for (let contractStrike in data.putExpDateMap[contractDate]) {
					contract = data.putExpDateMap[contractDate][contractStrike][0];
					if (contract.tradeTimeInLong) lastTrade = Math.round((Date.now() - contract.tradeTimeInLong)/60000);
					returnrate = Math.round(100*(contract.bid - dpremium)*365*1000*60*60*24
						/((contract.strikePrice - dstrike)*(contract.expirationDate-Date.now())));
					returnrate2 = Math.round(100*(contract.bid - apremium)*365*1000*60*60*24
						/((contract.strikePrice - astrike)*(contract.expirationDate-Date.now())));
					margin = Math.round(100*(data.underlyingPrice - contract.strikePrice)/data.underlyingPrice);
								  
					let threshold = 10;
					if (contract.daysToExpiration < 3) threshold = 0;  
					if (contract.bid > dpremium && lastTrade < 12*60 && returnrate > 19 && margin > threshold) {	
						if (returnrate2 > maxdata[merge[i]].put) maxdata[merge[i]].put = returnrate2;
					}
				}
			}
		}					       
		else D('msg').textContent = "Ticker not found.";		       
	})
	);
	}
	
	Promise.all(promises).then(function() {
		console.log(maxdata);
	});
}				 
					 
					 
	
function updateEarnings() {
	let weeklyQuery = 'https://query1.finance.yahoo.com/v7/finance/quote?symbols=' + weeklys.join();

	fetch("https://ansyble.herokuapp.com/cors/", 
		{cache:'no-cache', headers: {'Target-URL': weeklyQuery }}).then(function(response) {
		return response.json();
	}).then(function(data) { 

		if (data.quoteResponse.result) {
			let earningsTime = {};
			let earningsName = {};
			let earningsString = "<a target='_blank' href='https://finance.yahoo.com/calendar/earnings'>Earnings</a>: ";
			data.quoteResponse.result.forEach(function(stockData) {
				if (stockData.earningsTimestampStart == stockData.earningsTimestampEnd &&
					stockData.earningsTimestampEnd - Date.now()/1000 > -3*24*60*60 &&
					stockData.earningsTimestampEnd - Date.now()/1000 < 5*24*60*60) {
					earnings.push(stockData.symbol);
					earningsTime[stockData.symbol] = stockData.earningsTimestampEnd;
					earningsName[stockData.symbol] = stockData.longName;
				}
			});							      			
			earnings.sort(function(x, y) {
				return earningsTime[x]- earningsTime[y];
			});
			earnings.forEach(function(stock) {
				earningsString += "<a title='" + earningsName[stock] 
				+ "' target='_blank' href='https://finance.yahoo.com/quote/" + stock + "'><strong  style='color:#333'>" + stock + "</strong></a> ";							      
			});
			D('earnings').innerHTML = earningsString;
			D('earningsButton').textContent = "Add All";
		}
	});
}
	
function updateYolo() {
	let query = 'https://yolostocks.live/downloads/wallstreetbets.csv';
		
	fetch("https://ansyble.herokuapp.com/cors/", 
		{cache:'no-cache', headers: {'Target-URL': query }}).then(function(response) {
		return response.text();
	}).then(function(data) {
		preYoloList = data.replaceAll(" ", ",").replaceAll("\n", ",").split(",");
		
		yoloList = [];
		let prevWeekly = yoloWeeklyList;
		yoloWeeklyList = [];
		let yoloString = "<a target='_blank' href='https://yolostocks.live/'>YoloStocks</a> (" + new Date().toLocaleTimeString() + "): ";
		preYoloList.forEach(function(symbol) {
			if (symbol && /[A-Z]/.test(symbol[0])) {										  
				yoloList.push(symbol);
				if (weeklys.includes(symbol)) {
					yoloWeeklyList.push(symbol);					
					if (prevWeekly.length > 0 && !prevWeekly.includes(symbol)) {
						yoloString += "<strong style='color:blue'>" + symbol + "</strong> ";
						if (active(D('soundButton'))) D('audio').play();
						if (active(D('notificationButton'))) new Notification(symbol + " is newly trending on YoloStocks.");
					} else yoloString += "<strong>" + symbol + "</strong> ";
				} else yoloString += symbol + " ";
			}
		});
		D('yolo').innerHTML = yoloString;
		D('yoloButton').textContent = "Add Weeklys";
	});
}

function updateWSB() {
	let query = 'https://dashboard.nbshare.io/api/v1/apps/reddit';
		
	fetch("https://ansyble.herokuapp.com/cors/", 
		{cache:'no-cache', headers: {'Target-URL': query }}).then(function(response) {
		return response.json();
	}).then(function(data) {		
		wsbList = [];
		let prevWeekly = wsbWeeklyList;
		wsbWeeklyList = [];
		let wsbString = "<a target='_blank' href='https://dashboard.nbshare.io/apps/reddit/wallstreetbets/'>WSB</a> (" + new Date().toLocaleTimeString() + "): ";
		for (let i = 0; i < 15; i++) {
			let symbol = data[i].ticker;
			wsbList.push(symbol);
			if (weeklys.includes(symbol)) {
				wsbWeeklyList.push(symbol);
				if (prevWeekly.length > 0 && !prevWeekly.includes(symbol)) {
					wsbString += "<strong style='color:blue'>" + symbol + "</strong> ";
					if (active(D('soundButton'))) D('audio').play();
					if (active(D('notificationButton'))) new Notification(symbol + " is newly trending on WSB.");
				} else wsbString += "<strong>" + symbol + "</strong> ";
			} else wsbString += symbol + " ";
		}
		D('wsb').innerHTML = wsbString;
		D('wsbButton').textContent = "Add Weeklys";
	});
}
					      
function updateStocktwits() {
	let query = 'https://api.stocktwits.com/api/2/trending/symbols/equities.json';
		
	fetch("https://ansyble.herokuapp.com/cors/", 
		{cache:'no-cache', headers: {'Target-URL': query }}).then(function(response) {
		return response.json();
	}).then(function(data) {
		stList = [];
		let prevWeekly = stWeeklyList;
		stWeeklyList = [];
		let stString = "<a target='_blank' href='https://stocktwits.com/'>Stocktwits</a> (" + new Date().toLocaleTimeString() + "): ";
		data.symbols.forEach(function(stockData) {
			let symbol = stockData.symbol;
			stList.push(symbol);
			if (weeklys.includes(symbol)) {
				stWeeklyList.push(symbol);
				if (prevWeekly.length > 0 && !prevWeekly.includes(symbol)) {
					stString += "<a target='_blank' href='https://stocktwits.com/symbol/" + symbol + "'><strong style='color:blue'>" + symbol + "</strong></a> ";
					if (active(D('soundButton'))) D('audio').play();
					if (active(D('notificationButton'))) new Notification(symbol + " is newly trending on Stocktwits.");
				} else stString += "<a target='_blank' href='https://stocktwits.com/symbol/" + symbol + "'><strong style='color:#333'>" + symbol + "</strong></a> ";
			} else stString += "<a style='color:#333' target='_blank' href='https://stocktwits.com/symbol/" + symbol + "'>" + symbol + "</a> ";
		});
		D('stocktwits').innerHTML = stString;
		D('stButton').textContent = "Add Weeklys";
	});
}
	
function toggleAlerts(elt) {
	if (yahootimer) {
		deactivate(elt, "Auto-Refresh Off");
		clearInterval(yahootimer);
		clearInterval(sttimer);
		clearInterval(wsbtimer);
		yahootimer = "";
		for (let x in prices) {
			prices[x] = [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1];
			volumes[x] = [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1];
		}
	} else {	
		activate(elt, "Auto-Refresh On");
		update(); 
		updateAll();
		yahootimer = setInterval(function() { optionsChain(); update(); }, 10000);
		sttimer = setInterval(function() { updateStocktwits(); }, 60000);
		wsbtimer = setInterval(function() { updateWSB(); updateYolo(); }, 60000*5);
	}
}
	
function toggleSound(elt) {
	if (active(elt)) deactivate(elt, "Sound Off");
	else {	
		activate(elt, "Sound On");
		D('audio').play();
	}
}
	
function toggleNotifications(elt) {
	if (elt.textContent == "Notifications On") deactivate(elt, "Notifications Off");
	else {	
		if (!("Notification" in window)) alert("This browser does not support desktop notification");
		else if (Notification.permission === "granted") activate(elt, "Notifications On");
		else {
		Notification.requestPermission().then(function (permission) {
			if (permission === "granted") activate(elt, "Notifications On");
		});
		}	
	}
}
	
function val(elt) { return parseFloat(elt.value); }
						     
function updateDisplay(stock, fixed) {			
	let current = parseFloat(D(stock + "-current").textContent);
	let upelt = D(stock + "-upperPercent");
	let lpelt = D(stock + "-lowerPercent");	
	let lower = D(stock + "-lower");
	let upper = D(stock + "-upper");
	let upperMargin = D(stock + "-upperMargin");
	let lowerMargin = D(stock + "-lowerMargin");
	let slider = D(stock + "-slider");
						 
	if (!upelt.value) upelt.value = 0;
	if (!lpelt.value) lpelt.value = 0;
	if (!upperMargin.value) upperMargin.value = 0;
	if (!lowerMargin.value) lowerMargin.value = 0; 
	if (!lower.value) lower.value = current;
	if (!upper.value) upper.value = current;
					     
	if (fixed == lpelt || fixed == upelt) {				
		lower.value = round( current * (1 - val(lpelt)/100));
		upper.value = round( current * (1 + val(upelt)/100));
	} else if (fixed == upperMargin || fixed == lowerMargin) {	
		lower.value = round(current - val(lowerMargin));
		upper.value = round(current + val(upperMargin));
	} else if (fixed == slider) {
		let oldLower = val(lower);
		lower.value = round(current - (slider.value * (val(upper) - val(lower)) / 100));
		upper.value = round(val(upper) - oldLower + val(lower));
	}	 
				 
	if (lpelt != document.activeElement) lpelt.value = round(100*(current - val(lower))/current, true);
	if (upelt != document.activeElement) upelt.value = round(100*(val(upper) - current)/current, true);
	if (upperMargin != document.activeElement) upperMargin.value = round(val(upper) - current);
	if (lowerMargin != document.activeElement) lowerMargin.value = round(current - val(lower));
	if (val(upper) > val(lower)) {
		slider.value = Math.round((current - val(lower))/(val(upper) - val(lower))*100);
		if (slider.value > 100) slider.value = 100;
		if (slider.value < 0) slider.value = 0;
	} else { 
		if (current > val(upper)) slider.value = 100;
		else if (current < val(lower)) slider.value = 0;
		else slider.value = 50;
	}
						 
	if (val(lower) > current) {
		if (lower.style.fontWeight != "bold") {
			if (active(D('soundButton'))) D('audiodown').play();
			if (active(D('notificationButton'))) new Notification(stock + " is down to $" + current);
			lower.style.fontWeight = "bold";
			lpelt.style.fontWeight = "bold";
			lowerMargin.style.fontWeight = "bold";
		}
	} else {
		lower.style.fontWeight = "initial";
		lpelt.style.fontWeight = "initial";
		lowerMargin.style.fontWeight = "initial";
	}
	if (val(upper) < current) {
		if (upper.style.fontWeight != "bold") {
			if (active(D('soundButton'))) D('audio').play();
			if (active(D('notificationButton'))) new Notification(stock + " is up to $" + current);
			upper.style.fontWeight = "bold";
			upelt.style.fontWeight = "bold";
			upperMargin.style.fontWeight = "bold";
		}
	} else {
		upper.style.fontWeight = "initial";
		upelt.style.fontWeight = "initial";
		upperMargin.style.fontWeight = "initial";
	}
					      
	if (lower.style.fontWeight == "bold") {
		D(stock + "-current").style.fontWeight = "bold";
		D(stock + "-current").style.color = "#F00";
	} else if (upper.style.fontWeight == "bold") {
		D(stock + "-current").style.fontWeight = "bold";
		D(stock + "-current").style.color = "#3b7";
	} else {	      
		D(stock + "-current").style.fontWeight = "initial";
		D(stock + "-current").style.color = "#333";
	}
}

function update() {
	if (tickerList.length > 0) {
	let query = 'https://query1.finance.yahoo.com/v7/finance/quote?symbols=' + tickerList.join();
		
	fetch("https://ansyble.herokuapp.com/cors/", 
		{cache:'no-cache', headers: {'Target-URL': query }}).then(function(response) {
		return response.json();
	}).then(function(data) { 
	
	if (data.quoteResponse.result) {
		d = new Date();
		D('msg').textContent = d.toLocaleTimeString();
	
		data.quoteResponse.result.forEach(function(stockData) {
			let stock = stockData.symbol;
			let price = stockData.regularMarketPrice;
			let volume = stockData.regularMarketVolume;
			let dailyPercent = stockData.regularMarketChangePercent;
			let daily = stockData.regularMarketChange;
			D(stock + "-current").textContent = round(price);	
			D(stock + "-percent").textContent = stock + " " + round(daily) + " (" + round(dailyPercent, true) + "%)";
	
			if (dailyPercent > 0) D(stock + "-percent").style.color = "#3b7";
			else if (dailyPercent < 0) D(stock + "-percent").style.color = "#F00";
			else D(stock + "-percent").style.color = "#333";
			updateDisplay(stock);
						  
			if (volumes[stock][volumes[stock].length - 1] != volume ||
			    prices[stock][prices[stock].length - 1] != price) {
				volumes[stock].shift();			  
				volumes[stock].push(volume);
				prices[stock].shift();			  
				prices[stock].push(price);
									  
				function avgVariation(arr) {
					let diffarr = [];
					for (let i = 0; i < arr.length - 1; i++) {
						if (arr[i + 1] > 0 && arr[i] > 0) {
							if (arr[i + 1] > arr[i]) diffarr.push(arr[i + 1] - arr[i]);
							else diffarr.push(arr[i] - arr[i + 1]);
						}
					}
					if (diffarr.length < arr.length - 2) return -1;

					var total = 0;
					for(var i = 0; i < diffarr.length; i++) {
					    total += diffarr[i];
					}
					return avg = total / diffarr.length;
				}

				function currentVariation(arr) {
					if (arr[arr.length - 1] > 0 && arr[arr.length - 2] > 0) return arr[arr.length - 1] - arr[arr.length - 2];
					else return -1;
				}

				let avgVol = avgVariation(volumes[stock]);
				let avgPrice = avgVariation(prices[stock]);
				let curVol = currentVariation(volumes[stock]);
				let curPrice = currentVariation(prices[stock]);
	
				let notify = false;
				function activityNotification(str) {
					if (D(stock + "-percent").style.backgroundColor == "") {
						if (active(D('soundButton'))) {
							if (curPrice > 0) D('audio').play();
							else D('audiodown').play();
						}
						if (active(D('notificationButton'))) new Notification(stock + "'s " + str + " activity is elevated.");
					}
					notify = true;
				}

				if (avgPrice > 0 && curPrice > 0 && (curPrice > 4*avgPrice || curPrice + 4*avgPrice < 0)) activityNotification("price");
				if (avgVol > 0 && curVol > 0  && (curVol > 4*avgVol || curVol + 4*avgVol < 0)) activityNotification("volume");
				if (notify) {
					if (curPrice > 0) D(stock + "-percent").style.backgroundColor = "#dfd";
					else D(stock + "-percent").style.backgroundColor = "#fdd";   
					console.log(stock + " activity:");
					if (curVol > avgVol) console.log(curVol + " > " + avgVol);
					if (curPrice > avgPrice) console.log(curPrice + " > " + avgPrice);
				} else D(stock + "-percent").style.backgroundColor = "";
			}
		});	
	} else {
		var e = new Date();
		D('msg').textContent = d.toLocaleTimeString() + " (Refresh failed: " +  e.toLocaleTimeString() + ")";
	}
	}).catch(function(error) { 
		console.log(error); 	
		var e = new Date();
		D('msg').textContent = d.toLocaleTimeString() + " (Refresh failed: " +  e.toLocaleTimeString() + ")";
	});	
	}
}
	
function submitTicker() {
	// options: https://query2.finance.yahoo.com/v7/finance/options/
	// quote: https://query1.finance.yahoo.com/v7/finance/quote?symbols=
	let query = 'https://query1.finance.yahoo.com/v7/finance/quote?symbols=' + D('tickerInput').value.replaceAll(" ", ",");	
	fetch("https://ansyble.herokuapp.com/cors/", 
		{cache:'no-cache', headers: {'Target-URL': query }}).then(function(response) {
		return response.json();
	}).then(function(data) {
	
	// let buffer = data.optionChain.result[0].quote;
	let bufferList = data.quoteResponse.result;
	
	if (bufferList.length > 0) {
	for (let i = bufferList.length - 1; i > -1; i--) {
		let buffer = bufferList[i];
		let stock = buffer.symbol;
	
		if (!tickerList.includes(stock)) {			
			tickerList.push(stock);

			let newli = make("li");
			newli.id = stock;
			newli.style.textAlign = "center";
			newli.style.position = "relative";
	
			let newTicker = make("a");
			newTicker.id = stock + "-percent";
			newTicker.style.marginTop = "10px";
			newTicker.style.paddingLeft = "10px";
			newTicker.style.paddingRight = "10px";
			newTicker.textContent = stock + " " + round(buffer.regularMarketChange) + " (" + round(buffer.regularMarketChangePercent, true) + "%)";
			if (buffer.regularMarketChangePercent > 0) newTicker.style.color = "#3b7";
			else if (buffer.regularMarketChangePercent < 0) newTicker.style.color = "#FF0000";
			newTicker.href = "https://finance.yahoo.com/quote/" + stock;
			newTicker.target = "_blank";
	
			let newTickerX = make("button");
			newTickerX.textContent = "X";
			newTickerX.style.position = "absolute";
			newTickerX.style.top = "15px";
			newTickerX.style.right = "0px";
			newTickerX.onclick = function() { 
				tickerList.splice(tickerList.indexOf(stock), 1); 
				remove(newli); 
				delete volumes[stock];
				delete prices[stock];
			};	
	
			let lowerBound = make("input");
			lowerBound.type = "text";							
			lowerBound.id = stock + "-lower";
			lowerBound.style.width = "80px";
			setInput(lowerBound, stock);
								       
			let lowerMargin = make("input");
			lowerMargin.type = "text";							
			lowerMargin.id = stock + "-lowerMargin";
			lowerMargin.style.width = "80px";
			setInput(lowerMargin, stock);
			lowerMargin.style.marginLeft = "10px";  	
									      
			let lowerPercent = make("input");
			lowerPercent.type = "text";
			lowerPercent.value = defaultLower;
			lowerPercent.id = stock + "-lowerPercent";
			lowerPercent.style.width = "60px";	
			setInput(lowerPercent, stock);
								       
			let upperBound = make("input");
			upperBound.type = "text";
			upperBound.id = stock + "-upper";
			upperBound.style.width = "80px";
			setInput(upperBound, stock);		
								       
			let upperMargin = make("input");
			upperMargin.type = "text";							     
			upperMargin.id = stock + "-upperMargin";
			upperMargin.style.width = "80px";
			setInput(upperMargin, stock);
			upperMargin.style.marginRight = "10px";  	
								       
			let upperPercent = make("input");
			upperPercent.type = "text";
			upperPercent.value = defaultUpper;
			upperPercent.id = stock + "-upperPercent";
			upperPercent.style.width = "60px";
			setInput(upperPercent, stock);	
	
			let current = make("div");
			current.textContent = round(buffer.regularMarketPrice * 1);
			current.id = stock + "-current";
			current.style.display = "inline-block";
			current.style.paddingLeft = "10px";  	
			current.style.paddingRight = "10px";  			      
										      
			let slider = make("input");
			slider.id = stock + "-slider";
			slider.autocomplete = "off";
			slider.style.flexGrow = "1";							      
			slider.type = "range";
			slider.min = 0;
			slider.max =100;
			slider.step = 1;
			slider.value = 50;
			slider.style.marginLeft = "10px";
			slider.style.marginRight = "10px";
			slider.style.cursor = "pointer";
			slider.style.touchAction = "none";
			slider.oninput = function() {  updateDisplay(stock, slider); };
								
	
			let li1 = make('div');	    
			li1.appendChild(newTicker);
			li1.appendChild(newTickerX);
										      
			let li2 = make('div');	
			
			let parenth1 = make("span");
			parenth1.textContent = "(";
			li2.appendChild(parenth1);	
			li2.appendChild(lowerPercent);			      
			let percentsign1 = make("span");
			percentsign1.textContent = " %)";
			li2.appendChild(percentsign1);
							
			li2.appendChild(lowerMargin);
			li2.appendChild(current);
			li2.appendChild(upperMargin);
							
			let parenth2 = make("span");
			parenth2.textContent = "(";
			li2.appendChild(parenth2);				      
			li2.appendChild(upperPercent);									      
			let percentsign2 = make("span");
			percentsign2.textContent = " %)";	   
			li2.appendChild(percentsign2);	      
											      
			let li3 = make('div');	
			li3.style.display = "flex";
			li3.appendChild(lowerBound);
			li3.appendChild(slider);	
			li3.appendChild(upperBound);			      
										      
			newli.appendChild(li1);		
			newli.appendChild(li2);		
			newli.appendChild(li3);	
										      
			D('stocklist').insertBefore(newli, D('stocklist').firstChild);
										       
			updateDisplay(stock, upperPercent);
			volumes[stock] = [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1];
			prices[stock] = [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1];
										       
		} else D('stocklist').insertBefore(D(stock), D('stocklist').firstChild);
	
		D('tickerInput').value = "";
	}
	} else D('msg').textContent = "Ticker not found.";
	}).catch(function(error) { 
		console.log(error); 
		var e = new Date();
		D('msg').textContent = d.toLocaleTimeString() + " (Refresh failed: " +  e.toLocaleTimeString() + ")";
	});	
}
								       
function optionsChain() {	
								       
	let d = new Date(Date.now() + 1000*60*60*24*12).toISOString();
								       
	fetch("https://api.tdameritrade.com/v1/marketdata/chains?apikey=T1V8GYUYK3GKC7HG3L23O9XBJ5OH1C4F&symbol="
						+ D('optionsInput').value.toUpperCase() 
						+ "&range=OTM&toDate="
						+ d).then(function(response) {
		return response.json();
	}).then(function(data) {
		console.log(data);
		if (data.status == "SUCCESS") {
			D('optionslist').textContent = "";	
			function buildDefense(contract) {	
				let lastTrade = "x";
				let returnrate = "x";
				let returnrate2 = "x";
				if (contract.tradeTimeInLong) lastTrade = Math.round((Date.now() - contract.tradeTimeInLong)/60000);
				let margin = Math.round(100*(contract.strikePrice - data.underlyingPrice)/data.underlyingPrice);	
				if (contract.putCall == "PUT") margin = Math.round(100*(data.underlyingPrice - contract.strikePrice)/data.underlyingPrice);

				let myli = buildli(contract, lastTrade, margin, returnrate, returnrate2);
				myli.style.fontWeight = "bold";
				D('optionslist').appendChild(myli);
				return myli;
			}
			function buildli(contract, lastTrade, margin, returnrate, returnrate2) {
				let li = make('li');
				li.style.textAlign = "center";				       
				addCol("$" + contract.strikePrice + " " + contract.putCall, "100px", li);
				if (contract.putCall == "CALL") addCol("+" + margin + "%", "50px", li);
				else addCol("-" + margin + "%", "50px", li);
								       
				let rate = 295 - 2*returnrate;

				let col = addCol(returnrate + '/' + returnrate2 + "%", "100px", li);
				if (rate < 0) col.style.backgroundColor = "#00ffff";
				else if (rate < 16) col.style.backgroundColor = "#0" + rate.toString(16) + "ffff";
				else col.style.backgroundColor = "#" + rate.toString(16) + "ffff";
						   
				col = addCol(contract.bid.toFixed(2) + ' x ' + contract.bidSize, "100px", li);	
				if (rate < 0) col.style.backgroundColor = "#00ffff";
				else if (rate < 16) col.style.backgroundColor = "#0" + rate.toString(16) + "ffff";
						   
				else col.style.backgroundColor = "#" + rate.toString(16) + "ffff";							       
				addCol(contract.ask.toFixed(2) + ' x ' + contract.askSize, "100px", li);
				addCol(contract.last.toFixed(2), "50px", li);		
								       
				addCol(lastTrade + " m", "75px", li);
				addCol(contract.totalVolume, "50px", li);	

				return li;
			}
			function addCol(text, width, li) {								       
				let col = make('span');
				col.style.width = width;
				col.style.display = "inline-block";
				col.style.textAlign = "center";
				col.textContent = text;
				li.appendChild(col);  
				return col;
			}			
					
			for (let contractDate in data.callExpDateMap) {
						   
			/////////////////////// CALLS //////////////////////////////////
						   
				let dstrike = 0;
				let dpremium = 0; 
				let theStrike;
							
				let astrike = 0;
				let apremium = 0; 
				let theaStrike;
								       
				for (let contractStrike in data.callExpDateMap[contractDate]) {	
					let contract = data.callExpDateMap[contractDate][contractStrike][0];	
					if (contract.ask > 0) {	
						if (dpremium) {
							if (contract.ask < dpremium
								&& (apremium == 0 || dpremium < apremium || (dpremium == apremium && dstrike < astrike))) {
								astrike = dstrike;
								apremium = dpremium;
								theaStrike = theStrike;	
							} else if (contract.ask > dpremium 
								&& (apremium == 0 || contract.ask < apremium || (contract.ask == apremium && contract.strikePrice < astrike))) {
								astrike = contract.strikePrice;
								apremium = contract.ask;
								theaStrike = contractStrike;			       
							}
						}
						if (dpremium == 0 || contract.ask < dpremium || (contract.ask == dpremium && contract.strikePrice < dstrike)) {
							dstrike = contract.strikePrice;
							dpremium = contract.ask;
							theStrike = contractStrike;
						}
					}
				}	
				
				let referenceli = buildDefense(data.callExpDateMap[contractDate][theStrike][0]);	
				if (theaStrike) referenceli = buildDefense(data.callExpDateMap[contractDate][theaStrike][0]);
								       
				for (let contractStrike in data.callExpDateMap[contractDate]) {
					let contract = data.callExpDateMap[contractDate][contractStrike][0];
					if (contract.tradeTimeInLong) lastTrade = Math.round((Date.now() - contract.tradeTimeInLong)/60000);
					returnrate = Math.round(100*(contract.bid - dpremium)*365*1000*60*60*24
							/((dstrike - contract.strikePrice)*(contract.expirationDate-Date.now())));
					returnrate2 = Math.round(100*(contract.bid - apremium)*365*1000*60*60*24
							/((astrike - contract.strikePrice)*(contract.expirationDate-Date.now())));
					margin = Math.round(100*(contract.strikePrice - data.underlyingPrice)/data.underlyingPrice);
					let threshold = 19;
					if (contract.daysToExpiration < 3) threshold = 0;  
					if (contract.bid > dpremium && lastTrade < 12*60 && returnrate > 19 && margin > threshold) {
						if (!referenceli.nextElementSibling) D('optionslist').appendChild(buildli(contract, lastTrade, margin, returnrate, returnrate2));
						else D('optionslist').insertBefore(buildli(contract, lastTrade, margin, returnrate, returnrate2), 
						referenceli.nextElementSibling);
					}
				}
	
				referenceli = make('li');
				referenceli.style.textAlign = "center";
				referenceli.style.fontWeight = "bold";
				addCol("$" + round(data.underlyingPrice), "100px", referenceli);
				addCol(data.symbol + " " + data.callExpDateMap[contractDate][theStrike][0].daysToExpiration + " DTE", "575px", referenceli);
				D('optionslist').appendChild(referenceli);	
	
	
			/////////////////////// PUTS //////////////////////////////////
	
				dstrike = 0;
				dpremium = 0; 							
				astrike = 0;
				apremium = 0; 	
				theaStrike = "";
				theStrike = "";
				for (let contractStrike in data.putExpDateMap[contractDate]) {	
					let contract = data.putExpDateMap[contractDate][contractStrike][0];	
					if (contract.ask > 0) {	
						if (dpremium) {
							if (contract.ask < dpremium
								&& (apremium == 0 || dpremium < apremium || (dpremium == apremium && dstrike > astrike))) {
								astrike = dstrike;
								apremium = dpremium;
								theaStrike = theStrike;	
							} else if (contract.ask > dpremium 
								&& (apremium == 0 || contract.ask < apremium || (contract.ask == apremium && contract.strikePrice > astrike))) {
								astrike = contract.strikePrice;
								apremium = contract.ask;
								theaStrike = contractStrike;			       
							}
						}
						if (dpremium == 0 || contract.ask < dpremium || (contract.ask == dpremium && contract.strikePrice > dstrike)) {
							dstrike = contract.strikePrice;
							dpremium = contract.ask;
							theStrike = contractStrike;
						}
					}
				}	
								       
				for (let contractStrike in data.putExpDateMap[contractDate]) {
					contract = data.putExpDateMap[contractDate][contractStrike][0];
					if (contract.tradeTimeInLong) lastTrade = Math.round((Date.now() - contract.tradeTimeInLong)/60000);
					returnrate = Math.round(100*(contract.bid - dpremium)*365*1000*60*60*24
						/((contract.strikePrice - dstrike)*(contract.expirationDate-Date.now())));
					returnrate2 = Math.round(100*(contract.bid - apremium)*365*1000*60*60*24
						/((contract.strikePrice - astrike)*(contract.expirationDate-Date.now())));
					margin = Math.round(100*(data.underlyingPrice - contract.strikePrice)/data.underlyingPrice);
								  
					let threshold = 10;
					if (contract.daysToExpiration < 3) threshold = 0;  
					if (contract.bid > dpremium && lastTrade < 12*60 && returnrate > 19 && margin > threshold) {	
						if (!referenceli.nextElementSibling) 
							D('optionslist').appendChild(buildli(contract, lastTrade, margin, returnrate, returnrate2));
						else D('optionslist').insertBefore(buildli(contract, lastTrade, margin, returnrate, returnrate2), 
							referenceli.nextElementSibling);
					}
				}
				if (theaStrike) buildDefense(data.putExpDateMap[contractDate][theaStrike][0]);
				buildDefense(data.putExpDateMap[contractDate][theStrike][0]).style.marginBottom = "30px";
			}
		}					       
		else D('msg').textContent = "Ticker not found.";		       
	});								       
}

function setInput(elt, stock) {
	elt.style.textAlign = "center";	
	elt.onkeydown = function() { 
		if ((event.keyCode > 57 && event.keyCode < 91) && !event.altKey && !event.ctrlKey) event.preventDefault();
	}
	elt.onkeyup = function() {
		if (event.keyCode == 13) {
			event.preventDefault(); 
			elt.blur();
		}
	};   
	if (stock) elt.onblur = function() { updateDisplay(stock, elt); };   
} 
function deactivate(but, str) { 
	but.classList.remove("active");
	but.textContent = str;
}										       
function activate(but, str) { 
	but.classList.add("active");
	but.textContent = str;
}
function active(but) { return but.classList.contains("active"); }
function round(num, percent) { 
	if (num < 1 && !percent) return Math.round(num*1000)/1000;
	return Math.round(num*100)/100;
}
function D(string) { return document.getElementById(string);}
function make(string) { return document.createElement(string);}	
function remove(element) { element.parentNode.removeChild(element);}
</script>
    

	
Some notes: 
	
1. Quote data comes from Yahoo Finance and is real-time. Auto-refresh is per 10 seconds.
2. Yahoo Finance allows servers, but not clients, to access their API. I am using a free Heroku backend to circumvent this. Heroku's free tier sleeps after inactivity, so this means that your first requested quote might take a few seconds as the backend wakes up. All quotes thereafter should be reasonably speedy.
3. "Elevated price/volume activity" is measured on the minute scale.
4. This is currently designed for desktop use. Mobile is basically unusable, both from the interface point of view, and from the fact that mobile browsers sleep.
