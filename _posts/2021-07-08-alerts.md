---
title: "Stock alert applet"
---

A stock alert applet. Emits a ring and/or notification for price movements beyond a specified range. A ring/notification will also emit when a stock exhibits an unusually large change in price or volume. This is tuned for events on the intra-day scale.


<div style="min-width:400px">
	
	
<div style="margin-bottom:20px">
<button onclick="toggleAlerts(this);">Auto-Refresh Off</button><button onclick="update();">Refresh</button>
<span id="msg" style="margin-left:10px;"></span>
	
<audio id="audio" src="{{ "that-was-quick.mp3" | relative_url }}" autostart="false"></audio>
<button onclick="toggleNotifications(this);" id="notificationButton" style="float:right">Notifications Off</button>
<button onclick="toggleSound(this);" id="soundButton" class="active" style="float:right">Sound On</button>
</div>
	
<div style="width:max-content; margin:auto">
<input onkeyup="if (event.keyCode == 27) this.value = '';
		else if (event.keyCode == 13) {
			event.preventDefault(); 
			submitTicker();
		}"
id="tickerInput" autocomplete="off" placeholder="Add stock ticker..."> 
</div>
	
<ul style="list-style-type:none; padding-left:0px" id="stocklist"></ul>	
</div>


<script> ////////////////////////////////////////////////////////////////
	
var tickerList = [];
var volumes = {};
var prices = {};
let hourglasstimer;
var d = new Date();
	
function toggleAlerts(elt) {
	if (hourglasstimer) {
		deactivate(elt, "Auto-Refresh Off");
		clearInterval(hourglasstimer);
		hourglasstimer = "";
		for (let x in prices) {
			prices[x] = [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1];
			volumes[x] = [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1];
		}
	} else {	
		activate(elt, "Auto-Refresh On");
		hourglasstimer = setInterval(function() { update(); }, 10000);
	}
}
	
function toggleSound(elt) {
	if (active(elt)) deactivate(elt, "Sound Off");
	else {	
		activate(elt, "Sound On");
		D('audio').play();
	}
}
	
function toggleNotifications(elt) {
	if (elt.textContent == "Notifications On") {
		deactivate(elt, "Notifications Off");
	} else {	
		// Let's check if the browser supports notifications
		if (!("Notification" in window)) alert("This browser does not support desktop notification");

		// Let's check whether notification permissions have already been granted
		else if (Notification.permission === "granted") activate(elt, "Notifications On");
	
		// Otherwise, we need to ask the user for permission
		else if (Notification.permission !== "denied") {
		Notification.requestPermission().then(function (permission) {
			// If the user accepts, let's create a notification
			if (permission === "granted") activate(elt, "Notifications On");
		});
		}	
	}
}
			 
function updateSlider(stock, fixed) {
	let current = parseFloat(D(stock + "-current").value);
	let upper = parseFloat(D(stock + "-upper").value);
	let lower = parseFloat(D(stock + "-lower").value);
	let slider = D(stock + "-slider");
		     
	if (fixed) {	
		let newLower = round(current - (slider.value * (upper - lower) / 100));
		if (newLower < 0) newLower = 0;
		D(stock + "-lower").value = newLower;
		D(stock + "-upper").value = round(upper - lower + newLower);
	} else {
		if (upper > lower) {
			slider.value = Math.round((current - lower)/(upper - lower)*100);
			if (slider.value > 100) slider.value = 100;
			if (slider.value < 0) slider.value = 0;
		}
		else slider.value = 50;
	}		     
}
						     
function updatePercent(stock, fixed) {			
	let current = parseFloat(D(stock + "-current").value);
	let upelt = D(stock + "-upperPercent");
	let lpelt = D(stock + "-lowerPercent");	
	let lower = D(stock + "-lower");
	let upper = D(stock + "-upper");
					     
	if (fixed) {				
		if (lower != document.activeElement) lower.value = round( current * (1 - parseFloat(D(stock + "-lowerPercent").value)/100));
		if (upper != document.activeElement) upper.value = round( current * (1 + parseFloat(D(stock + "-upperPercent").value)/100));	     
	} else {
		if (lpelt != document.activeElement) lpelt.value = round(100*(current - parseFloat(lower.value))/current, true);
		if (upelt != document.activeElement) upelt.value = round(100*(parseFloat(upper.value) - current)/current, true);
	}
}

function updateLocal(stock, fixed) {
	updatePercent(stock, fixed);
	updateSlider(stock);					     
	let current = parseFloat(D(stock + "-current").value);
	
	let ring = false;
	if (current < parseFloat(D(stock + "-lower").value)) {
		if (D(stock + "-lower").style.fontWeight != "bold") {
			ring = true;
			if (active(D('notificationButton'))) new Notification(stock + " is " + "down" + " to $" + D(stock + "-current").value);
			D(stock + "-lower").style.fontWeight = "bold";
		}
	} else D(stock + "-lower").style.fontWeight = "initial";
	if (current > parseFloat(D(stock + "-upper").value)) {
		if (D(stock + "-upper").style.fontWeight != "bold") {
			ring = true;
			if (active(D('notificationButton'))) new Notification(stock + " is " + "up" + " to $" + D(stock + "-current").value);
			D(stock + "-upper").style.fontWeight = "bold";
		}
	} else D(stock + "-upper").style.fontWeight = "initial";
	
	if (ring && active(D('soundButton'))) D('audio').play();
}

function update() {
	if (tickerList.length > 0) {
	let query = 'https://query1.finance.yahoo.com/v7/finance/quote?symbols=' + tickerList.join();
		
	fetch("https://sandboxansyble.herokuapp.com/", 
		{cache:'no-cache', headers: {'Target-URL': query }}).then(function(response) {
		return response.json();
	}).then(function(data) { 
	
	let buffer = data.quoteResponse.result;
	
	if (buffer) {
		d = new Date();
		D('msg').textContent = d.toLocaleTimeString();
	
		let ring = false;
		buffer.forEach(function(stockData) {
			let stock = stockData.symbol;
			D(stock + "-current").value = round(stockData.regularMarketPrice * 1);
			D(stock + "-percent").textContent = stock + " " + round(stockData.regularMarketChangePercent, true) + "%";
	
			if (stockData.regularMarketChangePercent > 0) D(stock + "-percent").style.color = "#0b3";
			else if (stockData.regularMarketChangePercent < 0) D(stock + "-percent").style.color = "#FF0000";
			else D(stock + "-percent").style.color = "#333";
			
			if (volumes[stock][volumes[stock].length - 1] != stockData.regularMarketVolume ||
			    prices[stock][prices[stock].length - 1] != stockData.regularMarketPrice) {
				volumes[stock].shift();			  
				volumes[stock].push(stockData.regularMarketVolume);
				prices[stock].shift();			  
				prices[stock].push(stockData.regularMarketPrice);
									  
				function avgVariation(arr) {
					let diffarr = [];
					for (let i = 0; i < arr.length - 1; i++) {
						if (arr[i + 1] > 0 && arr[i] > 0) {
							if (arr[i + 1] > arr[i]) diffarr.push(arr[i + 1] - arr[i]);
							else diffarr.push(arr[i] - arr[i + 1]);
						}
					}
					if (diffarr.length < arr.length - 2) return -1;

					var total = 0;
					for(var i = 0; i < diffarr.length; i++) {
					    total += diffarr[i];
					}
					return avg = total / diffarr.length;
				}

				function currentVariation(arr) {
					let diffarr = [];
					for (let i = arr.length - 2; i < arr.length - 1; i++) {
						if (arr[i + 1] > 0 && arr[i] > 0) {
							if (arr[i + 1] > arr[i]) diffarr.push(arr[i + 1] - arr[i]);
							else diffarr.push(arr[i] - arr[i + 1]);
						}
					}
					if (diffarr.length > 0) return diffarr[0];
					else return -1;
				}

				let avgVol = avgVariation(volumes[stock]);
				let avgPrice = avgVariation(prices[stock]);
				let curVol = currentVariation(volumes[stock]);
				let curPrice = currentVariation(prices[stock]);

				let notify = false;
				if (avgPrice > 0 && curPrice > 0 && curPrice > 2*avgPrice) {
					if (D(stock + "-percent").style.fontWeight != "bold") {
						ring = true;
						notify = true;
						if (active(D('notificationButton'))) new Notification(stock + "'s " + "price" + " activity is unusually high.");
					}
				} 
				if (avgVol > 0 && curVol > 0  && curVol > 2*avgVol) {	
					if (D(stock + "-percent").style.fontWeight != "bold") {
						ring = true;
						notify = true;
						if (active(D('notificationButton'))) new Notification(stock + "'s " + "volume" + " activity is unusually high.");
					}
				} 
				if (notify) {
					D(stock + "-percent").style.fontWeight = "bold";
					console.log(stock);
					console.log(curVol + " > " + avgVol);
					console.log(curPrice + " > " + avgPrice);
				} else D(stock + "-percent").style.fontWeight = "initial";
			}
			updateLocal(stock);
		});	
	
		if (ring && active(D('soundButton'))) D('audio').play();
	
	} else {
		var e = new Date();
		D('msg').textContent = d.toLocaleTimeString() + "(Refresh failed: " +  e.toLocaleTimeString() + ")";
	}
	}).catch(function(error) { 
		console.log(error); 	
		var e = new Date();
		D('msg').textContent = d.toLocaleTimeString() + "(Refresh failed: " +  e.toLocaleTimeString() + ")";
	});	
	}
}
	
function submitTicker() {
	// options: https://query2.finance.yahoo.com/v7/finance/options/
	// quote: https://query1.finance.yahoo.com/v7/finance/quote?symbols=
	let query = 'https://query1.finance.yahoo.com/v7/finance/quote?symbols=' + D('tickerInput').value;	
	fetch("https://sandboxansyble.herokuapp.com/", 
		{cache:'no-cache', headers: {'Target-URL': query }}).then(function(response) {
		return response.json();
	}).then(function(data) {
	
	// let buffer = data.optionChain.result[0].quote;
	let buffer = data.quoteResponse.result[0];
	
	if (buffer) {	
		let stock = buffer.symbol;
	
		if (!tickerList.includes(stock)) {			
			tickerList.push(stock);

			let newli = make("li");
			newli.id = stock;
			newli.style.textAlign = "center";
	
			let newTicker = make("div");
			newTicker.id = stock + "-percent";
			newTicker.style.paddingTop = "10px";
			newTicker.textContent = stock + " " + round(buffer.regularMarketChangePercent) + "%";
			if (buffer.regularMarketChangePercent > 0) newTicker.style.color = "#0b3";
			else if (buffer.regularMarketChangePercent < 0) newTicker.style.color = "#FF0000";
	
			let newTickerX = make("button");
			newTickerX.textContent = "X";
			newTickerX.onclick = function() { 
				tickerList.splice(tickerList.indexOf(stock), 1); 
				remove(newli); 
				delete volumes[stock];
				delete prices[stock];
			};	
	
			function setInput(elt) {
				elt.style.textAlign = "center";	
				elt.onkeydown = function() { 
					if ((event.keyCode > 57 && event.keyCode < 91) && !event.altKey && !event.ctrlKey) event.preventDefault();
				}
				elt.onkeyup = function() {
					if (event.keyCode == 13) {
						event.preventDefault(); 
						elt.blur();
					}
				};					      
			}
	
			let lowerBound = make("input");
			lowerBound.value = round(buffer.regularMarketPrice * 0.98);
			lowerBound.id = stock + "-lower";
			lowerBound.style.width = "80px";
			lowerBound.onblur = function() { updateLocal(stock); };
			setInput(lowerBound);
									      
			let lowerPercent = make("input");
			lowerPercent.value = 2;
			lowerPercent.id = stock + "-lowerPercent";
			lowerPercent.style.width = "60px";	
			lowerPercent.onblur = function() {  updateLocal(stock, lowerPercent); };
			setInput(lowerPercent);
								       
			let upperBound = make("input");
			upperBound.value = round(buffer.regularMarketPrice * 1.02);
			upperBound.id = stock + "-upper";
			upperBound.style.width = "80px";
			upperBound.onblur = function() {  updateLocal(stock); };
			setInput(upperBound);	
								       
			let upperPercent = make("input");
			upperPercent.value = 2;
			upperPercent.id = stock + "-upperPercent";
			upperPercent.style.width = "60px";
			upperPercent.onblur = function() {  updateLocal(stock, upperPercent); };
			setInput(upperPercent);	
	
			let current = make("input");
			current.value = round(buffer.regularMarketPrice * 1);
			current.id = stock + "-current";
			current.disabled = true;
			current.style.border = "0px";
			current.style.backgroundColor = "transparent";
			current.style.color = "#333";
			current.style.textAlign = "center";
			current.style.width = "80px";  			      
										      
			let slider = make('input');
			slider.id = stock + "-slider";
			slider.autocomplete = "off";
			slider.style.flexGrow = "1";							      
			slider.type = "range";
			slider.min = 0;
			slider.max =100;
			slider.step = 1;
			slider.value = 50;
			slider.style.marginLeft = "10px";
			slider.style.marginRight = "10px";
			slider.style.cursor = "pointer";
			slider.style.touchAction = "none";
			slider.oninput = function() {  updateSlider(stock, slider); updatePercent(stock);  };
								
	
			let li1 = make('div');	    
			li1.appendChild(newTicker);
										      
			let li2 = make('div');			
										      
			lowerPercent.style.marginLeft = "50px";  								      
			li2.appendChild(lowerPercent);		
										      
			let percentsign1 = make("span");
			percentsign1.textContent = " %";
			li2.appendChild(percentsign1);
							
			li2.appendChild(current);
										      
			li2.appendChild(upperPercent);	
										      
			let percentsign2 = make("span");
			percentsign2.textContent = " %";	     
			percentsign2.style.marginRight = "20px";
			li2.appendChild(percentsign2);
							
			li2.appendChild(newTickerX);
										      
											      
			let li3 = make('div');	
			li3.style.display = "flex";
			li3.appendChild(lowerBound);
			li3.appendChild(slider);	
			li3.appendChild(upperBound);			      
										      
			newli.appendChild(li1);		
			newli.appendChild(li2);		
			newli.appendChild(li3);	
										      
			D('stocklist').insertBefore(newli, D('stocklist').firstChild);
										       
			volumes[stock] = [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1];
			prices[stock] = [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1];
										       
		} else D('stocklist').insertBefore(D(stock), D('stocklist').firstChild);
	
		D('tickerInput').value = "";
	
	} else D('msg').textContent = "Ticker not found.";
	}).catch(function(error) { 
		console.log(error); 
		var e = new Date();
		D('msg').textContent = d.toLocaleTimeString() + "(Refresh failed: " +  e.toLocaleTimeString() + ")";
	});	
}
										       
function deactivate(but, str) { 
	but.classList.remove("active");
	but.textContent = str;
}										       
function activate(but, str) { 
	but.classList.add("active");
	but.textContent = str;
}
function active(but) { return but.classList.contains("active"); }
function round(num, percent) { 
	if (num < 1 && !percent) return Math.round(num*1000)/1000;
	return Math.round(num*100)/100;
}
function D(string) { return document.getElementById(string);}
function make(string) { return document.createElement(string);}	
function remove(element) { element.parentNode.removeChild(element);}
</script>
    
