---
title: "Stock alert applet"
---

A stock alert applet (under development). 

<div>
	
	
<div id="msg" style="width:max-content; margin-left:auto; margin-right:0px; cursor:pointer" onclick="update()">Refreshed: N/A</div>
	
<div style="width:max-content; margin:auto">
<input onkeyup="if (event.keyCode == 27) this.value = '';
		else if (event.keyCode == 13) {
			event.preventDefault(); 
			submitTicker();
		}"
id="tickerInput" style="margin:20px;" autocomplete="off" placeholder="Add stock ticker..."> 
</div>
	
<div style="width:max-content; margin:auto">
<audio id="audio" src="{{ "that-was-quick.mp3" | relative_url }}" autostart="false"></audio>
<button onclick="toggleAlerts(this);">Auto-Refresh Off</button>
<button onclick="toggleSound(this);" id="soundButton">Sound Off</button>
<button onclick="toggleNotifications(this);" id="notificationButton">Notifications Off</button>
</div>
	
<ul style="list-style-type:none; padding-left:0px" id="stocklist"></ul>
	
</div>

<script> ////////////////////////////////////////////////////////////////
var tickerList = [];
var volumes = {};
var prices = {};
let hourglasstimer;
	
function avgVariation(arr) {
	let diffarr = [];
	for (let i = 0; i < arr.length - 1; i++) {
		if (arr[i + 1] > 0 && arr[i] > 0) {
			if (arr[i + 1] > arr[i]) diffarr.push(arr[i + 1] - arr[i]);
			else diffarr.push(arr[i] - arr[i + 1]);
		}
	}
	if (diffarr.length < arr.length - 2) return -1;
				       
	var total = 0;
	for(var i = 0; i < diffarr.length; i++) {
	    total += diffarr[i];
	}
	return avg = total / diffarr.length;
}
	
function currentVariation(arr) {
	let diffarr = [];
	for (let i = arr.length - 2; i < arr.length - 1; i++) {
		if (arr[i + 1] > 0 && arr[i] > 0) {
			if (arr[i + 1] > arr[i]) diffarr.push(arr[i + 1] - arr[i]);
			else diffarr.push(arr[i] - arr[i + 1]);
		}
	}
	if (diffarr.length > 0) return diffarr[0];
	else return -1;
}
	
function toggleAlerts(elt) {
	if (hourglasstimer) {
		elt.style.backgroundColor = "";
		elt.textContent = "Auto-Refresh Off";
		clearInterval(hourglasstimer);
		hourglasstimer = "";
		for (let x in prices) {
			prices[x] = [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1];
			volumes[x] = [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1];
		}
	} else {	
		elt.style.backgroundColor = "#aaa";
		elt.textContent = "Auto-Refresh On";
		hourglasstimer = setInterval(function() {
			update();
		}, 5000);
	}
}
	
function toggleSound(elt) {
	if (elt.textContent == "Sound On") {
		elt.style.backgroundColor = "";
		elt.textContent = "Sound Off";
	} else {	
		elt.style.backgroundColor = "#aaa";
		elt.textContent = "Sound On";
		D('audio').play();
	}
}
	
function toggleNotifications(elt) {
	if (elt.textContent == "Notifications On") {
		elt.style.backgroundColor = "";
		elt.textContent = "Notifications Off";
	} else {	
	
		  // Let's check if the browser supports notifications
		  if (!("Notification" in window)) alert("This browser does not support desktop notification");

		  // Let's check whether notification permissions have already been granted
		  else if (Notification.permission === "granted") {	
			elt.style.backgroundColor = "#aaa";
			elt.textContent = "Notifications On";
		  }	
		  // Otherwise, we need to ask the user for permission
		  else if (Notification.permission !== "denied") {
		    Notification.requestPermission().then(function (permission) {
		      // If the user accepts, let's create a notification
		      if (permission === "granted") {
				elt.style.backgroundColor = "#aaa";
				elt.textContent = "Notifications On";
		      }
		    });
		  }	
	}
}


function update() {
	if (tickerList.length > 0) {
	let query = 'https://query1.finance.yahoo.com/v7/finance/quote?symbols=' + tickerList.join();
		
	fetch("https://sandboxansyble.herokuapp.com/", 
		{cache:'no-cache', headers: {'Target-URL': query }}).then(function(response) {
		return response.json();
	}).then(function(data) { 
	
	let buffer = data.quoteResponse.result;
	
	if (buffer) {
		let ring = false;
		var d = new Date();
		var n = d.toLocaleTimeString();
		D('msg').textContent = "Refreshed: " + n;
		buffer.forEach(function(stockData) {
			D(stockData.symbol + "-current").value = round(stockData.regularMarketPrice * 1);
			D(stockData.symbol + "-percent").textContent = stockData.symbol + " " + round(stockData.regularMarketChangePercent) + "%";
	
			if (stockData.regularMarketChangePercent > 0) D(stockData.symbol + "-percent").style.color = "#0b3";
			else if (stockData.regularMarketChangePercent < 0) D(stockData.symbol + "-percent").style.color = "#FF0000";
			else D(stockData.symbol + "-percent").style.color = "#333";
									  
			volumes[stockData.symbol].shift();			  
			volumes[stockData.symbol].push(stockData.regularMarketVolume);
			prices[stockData.symbol].shift();			  
			prices[stockData.symbol].push(stockData.regularMarketPrice);
									  
									  	
			let avgVol = avgVariation(volumes[stockData.symbol]);
			let avgPrice = avgVariation(prices[stockData.symbol]);
			let curVol = currentVariation(volumes[stockData.symbol]);
			let curPrice = currentVariation(prices[stockData.symbol]);
			console.log(stockData.symbol);
			console.log(avgVol);
			console.log(avgPrice);
			let direction = "";
			if (avgPrice > 0 && curPrice > 0 && curPrice > 2*avgPrice) {
				if (D(stockData.symbol + "-percent").style.fontWeight != "bold") {
					ring = true;
					direction = "price";
					D(stockData.symbol + "-percent").style.fontWeight = "bold";
				}
			} else D(stockData.symbol + "-percent").style.fontWeight = "initial";
	
			if (avgVol > 0 && curVol > 0  && curVol > 2*avgVol) {
				if (D(stockData.symbol + "-percent").style.fontWeight != "bold") {
					ring = true;
					direction = "volume";
					D(stockData.symbol + "-current").style.fontWeight = "bold";
				}
			} else D(stockData.symbol + "-current").style.fontWeight = "initial";
	
			if (direction && D('notificationButton').textContent == "Notifications On")
				new Notification(stockData.symbol + "'s " + direction + " is high.");
		});	
		tickerList.forEach(function(stock) {
			console.log("updating " + stock);

			let current = parseFloat(D(stock + "-current").value);
			let upper = parseFloat(D(stock + "-upper").value);
			let lower = parseFloat(D(stock + "-lower").value);

			let direction = "";
			if (current < lower) {
				if (D(stock + "-lower").style.fontWeight != "bold") {
					ring = true;
					direction = "down";
					D(stock + "-lower").style.fontWeight = "bold";
				}
			} else D(stock + "-lower").style.fontWeight = "initial";
			if (current > upper) {
				if (D(stock + "-upper").style.fontWeight != "bold") {
					ring = true;
					direction = "up";
					D(stock + "-upper").style.fontWeight = "bold";
				}
			} else D(stock + "-upper").style.fontWeight = "initial";

			if (direction && D('notificationButton').textContent == "Notifications On")
				new Notification(stock + " is " + direction + " to $" + D(stock + "-current").value);
		});
	
		if (ring && D('soundButton').textContent == "Sound On") D('audio').play();	
	
	} else D('msg').textContent = "Auto-refresh error.";	
	}).catch(function(error) { console.log(error); });	
	}
}
	
function submitTicker() {
	// options: https://query2.finance.yahoo.com/v7/finance/options/
	// quote: https://query1.finance.yahoo.com/v7/finance/quote?symbols=
	let query = 'https://query1.finance.yahoo.com/v7/finance/quote?symbols=' + D('tickerInput').value;	
	fetch("https://sandboxansyble.herokuapp.com/", 
		{cache:'no-cache', headers: {'Target-URL': query }}).then(function(response) {
		return response.json();
	}).then(function(data) { 
	
	// let buffer = data.optionChain.result[0].quote;
	let buffer = data.quoteResponse.result[0];
	
	if (buffer) {	
		let stock = buffer.symbol;
	
		if (!tickerList.includes(stock)) {			
			tickerList.push(stock);

			let newli = make("li");
			newli.id = stock;
	
			let newTickerX = make("button");
			newTickerX.textContent = "X";
			newTickerX.onclick = function() { 
				tickerList.splice(tickerList.indexOf(stock), 1); 
				remove(newli); 
				delete volumes[stock];
				delete prices[stock];
			};	
	
			let newTicker = make("div");
			newTicker.id = stock + "-percent";
			newTicker.style.paddingTop = "10px";
			newTicker.textContent = stock + " " + round(buffer.regularMarketChangePercent) + "%";
			newTicker.style.display = "inline-block";	
				newTicker.style.textAlign = "center";
				newTicker.style.width = "max-content";
			if (buffer.regularMarketChangePercent > 0) newTicker.style.color = "#0b3";
			else if (buffer.regularMarketChangePercent < 0) newTicker.style.color = "#FF0000";
	
			let lowerBound = make("input");
			lowerBound.value = round(buffer.regularMarketPrice * 0.98);
			lowerBound.id = stock + "-lower";
				lowerBound.style.textAlign = "center";
				lowerBound.style.width = "80px";	
			lowerBound.onblur = function() { update() };
			lowerBound.onkeyup = function() {
				if (event.keyCode == 13) {
					event.preventDefault(); 
					lowerBound.blur();
				}
			};
	
			let current = make("input");
			current.value = round(buffer.regularMarketPrice * 1);
			current.id = stock + "-current";
			current.disabled = true;
			current.style.border = "0px";
			current.style.backgroundColor = "transparent";
			current.style.color = "#333";
				current.style.textAlign = "center";
				current.style.width = "80px";
	
			let upperBound = make("input");
			upperBound.value = round(buffer.regularMarketPrice * 1.02);
			upperBound.id = stock + "-upper";
				upperBound.style.textAlign = "center";
				upperBound.style.width = "80px";
			upperBound.onblur = function() { update() };
			upperBound.onkeyup = function() {
				if (event.keyCode == 13) {
					event.preventDefault(); 
					lowerBound.blur();
				}
			};
	
			let m1 = make("button");
			m1.textContent = "1%";
			m1.onclick = function() { 	
				lowerBound.value = round(buffer.regularMarketPrice * 0.99);
				update();
			};	
			let m2 = make("button");
			m2.textContent = "2%";
			m2.onclick = function() { 	
				lowerBound.value = round(buffer.regularMarketPrice * 0.98);
				update();
			};	
			let m4 = make("button");
			m4.textContent = "4%";
			m4.onclick = function() { 	
				lowerBound.value = round(buffer.regularMarketPrice * 0.96);
				update();
			};	
			let m8 = make("button");
			m8.textContent = "8%";
			m8.onclick = function() { 	
				lowerBound.value = round(buffer.regularMarketPrice * 0.92);
				update();
			};	
	
	
			
			let n1 = make("button");
			n1.textContent = "1%";
			n1.onclick = function() { 	
				upperBound.value = round(buffer.regularMarketPrice * 1.01);
				update();
			};	
			let n2 = make("button");
			n2.textContent = "2%";
			n2.onclick = function() { 	
				upperBound.value = round(buffer.regularMarketPrice * 1.02);
				update();
			};	
			let n4 = make("button");
			n4.textContent = "4%";
			n4.onclick = function() { 	
				upperBound.value = round(buffer.regularMarketPrice * 1.04);
				update();
			};	
			let n8 = make("button");
			n8.textContent = "8%";
			n8.onclick = function() { 	
				upperBound.value = round(buffer.regularMarketPrice * 1.08);
				update();
			};	
	
	
			m1.style.marginRight = "20px";
			m8.style.marginLeft = "50px";
			n1.style.marginLeft = "20px";
			n8.style.marginRight = "20px";
	
			let li1 = make('div');	    
			let li2 = make('div'); 
			li1.style.margin = "auto";
			li2.style.margin = "auto";	   
			li1.style.width = "max-content";
			li2.style.width = "max-content";	    	
			li1.appendChild(newTicker);
			li2.appendChild(m8);
			li2.appendChild(m4);
			li2.appendChild(m2);
			li2.appendChild(m1);
			li2.appendChild(lowerBound);
			li2.appendChild(current);
			li2.appendChild(upperBound);
			li2.appendChild(n1);
			li2.appendChild(n2);
			li2.appendChild(n4);
			li2.appendChild(n8);
			li2.appendChild(newTickerX);
			newli.appendChild(li1);		
			newli.appendChild(li2);
			D('stocklist').insertBefore(newli, D('stocklist').firstChild);
			volumes[stock] = [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1];
			prices[stock] = [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1];
		} else D('stocklist').insertBefore(D(stock), D('stocklist').firstChild);
	
		D('tickerInput').value = "";
	
	} else D('msg').textContent = "Ticker doesn't exist.";	
	}).catch(function(error) { console.log(error); });	
}
	
function round(num) {
	if (num > 1) return Math.floor(num*100)/100;
	return Math.floor(num*1000)/1000;
}
function D(string) { return document.getElementById(string);}
function make(string) { return document.createElement(string);}	
function remove(element) { element.parentNode.removeChild(element);}
</script>
    
